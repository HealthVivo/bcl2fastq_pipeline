This will be our new bcl to fastq pipeline, but using V1 of bcl2fastq from Illumina. Features will include:

  * Runs as a background process, rather than a cron job that needs to check if another instance is already running
  * Handles undetermined indices in a more coherent manner
  * Adds quality metrics to the report email
  * Compiles an automated project-report (pdf), to go along with each submission. This uses [ReportLab](https://pypi.python.org/pypi/reportlab).
  * Functions divided into more meaningful subfiles in a module, rather than being scattered across levels of shell scripts
  * Written explicitly for python3, just to future proof things a bit.

General workflow
================
The general workflow of this pipeline is as follows:
  1. Read in `bcl2fastq.ini` from `~/`. Note that this file can be changed while the program is running.
  2. Look for new flow cells.
    1. Iterate through directories listed under `[Paths]`->`baseDir`, looking for the special `RTAComplete.txt` file.
      * This program is currently hardcoded to look only in flow cells generated by machine SN7001180. This could trivially be changed.
    2. For each complete directory, check to see if it has already been processed.
      * A flow cell is marked as being processed if:
        1. There is an equivalent directory under `[Paths]`->`outputDir`
        2. That directory contains a file named `casava.finished` (our old pipeline) or `fastq.made` (the current program)
    3. This sets the `[Options]`->`runID` field in the configuration file.
  3. If there are no new flow cells to process, the program sleeps (the duration is set in `[Options]`->`sleepTime`)  and starts again at step 1.
  4. If there are new flow cells to process, ensure that there is sufficient space in `[Paths]`->`outputDir`. This is set in `[Options]`->`minSpace`.
    * Note that having insufficient space will lead to an email being sent to addresses set in `[Email]`->`errorTo`. The program will then sleep (see step 3) and loop (i.e., go back to step 1).
  5. Assuming there is at least one new flow cell and there's sufficient space, the program will generate fastq files.
    1. The program specified via `[bcl2fastq]`->`configure` is run with options specified in `[bcl2fastq]`->`configure_options`. In addition to these options, the follow are hard coded:
      1. `-o outputDir/runID`: The output directory is set to `[Paths]`->`outputDir/runID`. This directory is created if it doesn't already exist.
      2. `--input-dir runDir/runID`: This is the directory that's being processed (`[Paths]`->`runDir`/`runID`).
        * This directory may be read only!
    2. Note that a modified sample sheet is used, since the original one isn't compatible.
  6. Samples split across lanes are merged together. The resulting files are also renamed to have the sample names provided by the user. The original files are then deleted.
  7. A number of "post make" steps are run. This terminology is a hold-over from the previous bcl2fastq pipeline, which used `make` to generate the fastq files.
    1. FastQC is run on each output fastq file.
      * This is run in a multithreaded manner, see `[Options]`->`postMakeThreads` for the number of workers.
      * See options under `[FastQC]` for executable paths and options.
      * The output is placed in `[Paths]`->`outputDir`/`runID`/FASTQC_project_name.
    2. An md5sum is made of the fastq files in each project (see the file named "md5sums.txt").
      * As with FastQC, this is multithreaded, with the number of workers threads set via `[Options]`->`postMakeThreads`.
    3. Additional steps can be added to `afterFastq.py`, though note that the package will need to be reinstalled and the process restarted.
  8. Xml files and FastQC outputs are copied to a location readable by the sequencing facility.
    * This is location is set via `[Paths]`->`seqFacDir` and things placed under a `runID` subdirectory, as was the case with `InterOp` above.
    * Currently, the xml files are `RunInfo.xml` and `runParameters.xml`.
  9. A summary PDF file is created for each of the projects. All of the metrics from this are gathered from `Stats/ConversionStats.xml`.
    * Everything about these PDFs is hard-coded. In an ideal world, this would have some sort of plugin interface.
  10. FastQC and fastq files are copied to the group directories, under `sequencing_data/`.
    * If the directories already exist then an error is produced. This is to ensure that nothing is inadvertently over-written!
    * Only projects starting with the letters "A" or "C" will be distributed. Those starting with "A" are distributed to the groups and those with "C" to Andreas (`[Paths]->DEEPDir`).
  11. A summary email is produced (largely by parsing `Stats/DemultiplexingStats.xml`) and sent to the email addresses specified via `[Email]`->`finishedTo`.
    * Note the other options under `[Email]`, which specify the host name of the outgoing email server and the outgoing email address.
  12. A file named `fastq.made` is produced in `[Paths]`->`outputDir`/`runID`/.

Configuration file
==================
The configuration file is a human readable text file named `bcl2fastq.ini` and must be placed in the home directory (`~/`) of the user running this package. Currently, the file has the following sections:
  * `[Paths]` - Holds all path information
    * `baseDir` - The base directory where the HiSeq writes its output
    * `outputDir` - The base directory where the demultiplexed fastq files and fastQC/md5sum output should be written.
    * `seqFacDir` - The base directory readable by the sequencing facility, for the files they're interested in.
    * `groupDir` - The base directory holding all group's datasets (currently, this should be `/data` for us).
    * `DEEPDir` - The base directory holding all DEEP datasets.
    * `UniDir` - The base directory to hold all universitry datasets.
    * `logDir` - The directory in which `make` logs are written. Illumina's software can be quite verbose...
  * `[FastQC]`
    * `fastqc_command` - Either just `fastqc` or possibly the full path, as appropriate.
    * `fastqc_options` - Options for fastqc
  * `[bcl2fastq]`
    * `bcl2fastq` - Either just `bcl2fastq` or pissibly the full path, as appropriate.
    * `bcl2fastq_options` - The options for `bcl2fastq`. Something like `--use-bases-mask Y*,I6n,Y* -l WARNING --barcode-mismatches 0 --no-lane-splitting` is recommended.
    * `configure` - The path the the `configureBclToFastq.py` command.
    * `configure_options` - Options for above.
    * `make_threads` - How many threads `make` should use.
  * `[Options]` - These are more generic options that don't fit elsewhere.
    * `postMakeThreads` - After the fastq files are made, things like fastqc are run on each of them. This value sets the total number of worker threads that are used to do that.
    * `minSpace` - The minimum free space (in gigabytes) that must be free in the `outputDir`. Having less free space than this results in an error email message.
    * `sleepTime` - The amount of time the programs sleeps before restarting (in hours). Importantly, if something is broken and error emails begin to be sent then this also specifies how frequently they'll be produced.
    * `runID` - This should be left blank.
  * `[Email]`
    * `errorTo` - A comma-separated list of email addresses to which error reports should be sent.
    * `finishedTo` - A comma-separated list of email addresses to which reports of finishing a flow cell should be sent.
    * `fromAddress` - The email address from which emails are sent.
    * `host` - The outgoing email server.
  * `[Version]` - Everything under here is included in the PDF files generated for each project.
    * `pipeline` - A version number for this package
    * `bcl2fastq` - The version number of bcl2fastq from Illumina
    * `fastQC` - The version number of fastQC.

A few general notes are in order:
  * Blank lines my be added pretty much anywhere.
  * Comments need to be on separate lines and can be preceded by either `#` or `;`.
  * The order of things doesn't matter.
  * Quotes should not be used! `fastqc=/usr/bin/fastqc` is not the same as `fastqc="/usr/bin/fastqc"`!
  * All mentioned settings **must** be present! There's currently no method to support skipping steps if a line is blank or absent!

Dependencies
============
This package has the following dependencies:
  * Python3 (python2 will explicitly not work, since some package and function names differ).
  * The configparser module
  * The reportlab module
  * bcl2fastq version 1.8.4 (or newer)
  * FastQC must be present
  * md5sum must be present
  * There must be an available sendmail server somewhere. This package currently does not support authentication, but that could presumably be added.

To Do
=====
 - [ ] Remove remnant debugging steps.
